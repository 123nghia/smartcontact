const hre = require("hardhat");

/**
 * üß™ Test Script for Already Deployed TokenHub V2 Contract
 * Tests contract that is already deployed on BSC Testnet
 */
async function main() {
    console.log("üß™ ===== TESTING DEPLOYED TOKENHUB V2 CONTRACT =====");
    console.log("üìÖ Test Time:", new Date().toISOString());

    // BSC Testnet Contract Address (update this with your deployed contract)
    const contractAddress = "0x2F2e0f681A03e0692430C4683Ca60c652063354d";
    console.log("üìç Contract Address:", contractAddress);

    // Get tester account
    const [tester] = await hre.ethers.getSigners();
    console.log("üë§ Tester:", tester.address);

    // Connect to deployed contract
    console.log("\nüîó Connecting to deployed contract...");
    const TokenHubV2 = await hre.ethers.getContractFactory("TokenHubV2");
    const tokenHub = TokenHubV2.attach(contractAddress);
    console.log("‚úÖ Connected to deployed contract");

    // ===== 1. BASIC CONTRACT INFO =====
    console.log("\nüìã ===== 1. BASIC CONTRACT INFO =====");
    
    try {
        const name = await tokenHub.name();
        const symbol = await tokenHub.symbol();
        const decimals = await tokenHub.decimals();
        const totalSupply = await tokenHub.totalSupply();
        const network = await hre.ethers.provider.getNetwork();
        
        console.log("‚úÖ Contract Name:", name);
        console.log("‚úÖ Token Symbol:", symbol);
        console.log("‚úÖ Decimals:", decimals.toString());
        console.log("‚úÖ Total Supply:", hre.ethers.formatUnits(totalSupply, 18), "THD");
        console.log("‚úÖ Network:", network.name);
        console.log("‚úÖ Chain ID:", network.chainId.toString());
        console.log("‚úÖ Contract Address:", contractAddress);
        console.log("‚úÖ BSCScan URL:", `https://testnet.bscscan.com/address/${contractAddress}`);
        
    } catch (error) {
        console.log("‚ùå Error getting basic info:", error.message);
    }

    // ===== 2. TOKEN ALLOCATION VERIFICATION =====
    console.log("\nüìä ===== 2. TOKEN ALLOCATION VERIFICATION =====");
    
    try {
        const teamAllocation = await tokenHub.TEAM_ALLOCATION();
        const nodeOGAllocation = await tokenHub.NODE_OG_ALLOCATION();
        const liquidityAllocation = await tokenHub.LIQUIDITY_ALLOCATION();
        const communityAllocation = await tokenHub.COMMUNITY_ALLOCATION();
        const stakingAllocation = await tokenHub.STAKING_ALLOCATION();
        const ecosystemAllocation = await tokenHub.ECOSYSTEM_ALLOCATION();
        const treasuryAllocation = await tokenHub.TREASURY_ALLOCATION();
        
        const totalSupply = await tokenHub.totalSupply();
        
        console.log("üìà Team & Advisors:", hre.ethers.formatUnits(teamAllocation, 18), "THD");
        console.log("üìà Node OG:", hre.ethers.formatUnits(nodeOGAllocation, 18), "THD");
        console.log("üìà Liquidity & Market Making:", hre.ethers.formatUnits(liquidityAllocation, 18), "THD");
        console.log("üìà Community & Marketing:", hre.ethers.formatUnits(communityAllocation, 18), "THD");
        console.log("üìà Staking & Rewards:", hre.ethers.formatUnits(stakingAllocation, 18), "THD");
        console.log("üìà Ecosystem & Partnerships:", hre.ethers.formatUnits(ecosystemAllocation, 18), "THD");
        console.log("üìà Treasury / Reserve Fund:", hre.ethers.formatUnits(treasuryAllocation, 18), "THD");
        
        const totalAllocation = teamAllocation + nodeOGAllocation + liquidityAllocation + 
                              communityAllocation + stakingAllocation + ecosystemAllocation + 
                              treasuryAllocation;
        console.log("üìä T·ªîNG C·ªòNG:", hre.ethers.formatUnits(totalAllocation, 18), "THD");
        
        // Verify allocation is correct
        const allocationCorrect = totalAllocation === totalSupply;
        console.log("‚úÖ Allocation Verification:", allocationCorrect ? "PASS" : "FAIL");
        
    } catch (error) {
        console.log("‚ùå Error verifying allocation:", error.message);
    }

    // ===== 3. VESTING SCHEDULE CALCULATION =====
    console.log("\nüìÖ ===== 3. VESTING SCHEDULE CALCULATION =====");
    
    try {
        const nodeOGAllocation = await tokenHub.NODE_OG_ALLOCATION();
        const liquidityAllocation = await tokenHub.LIQUIDITY_ALLOCATION();
        const communityAllocation = await tokenHub.COMMUNITY_ALLOCATION();
        const ecosystemAllocation = await tokenHub.ECOSYSTEM_ALLOCATION();
        const treasuryAllocation = await tokenHub.TREASURY_ALLOCATION();
        
        // Calculate TGE releases
        const tgeNodeOG = (nodeOGAllocation * 10n) / 100n;
        const tgeLiquidity = (liquidityAllocation * 40n) / 100n;
        const tgeCommunity = (communityAllocation * 20n) / 100n;
        const tgeEcosystem = (ecosystemAllocation * 10n) / 100n;
        const tgeTreasury = (treasuryAllocation * 20n) / 100n;
        const totalTGE = tgeNodeOG + tgeLiquidity + tgeCommunity + tgeEcosystem + tgeTreasury;
        
        const totalSupply = await tokenHub.totalSupply();
        const tgePercentage = (totalTGE * 100n) / totalSupply;
        
        console.log("üåü Node OG TGE:", hre.ethers.formatUnits(tgeNodeOG, 18), "THD (10%)");
        console.log("üíß Liquidity TGE:", hre.ethers.formatUnits(tgeLiquidity, 18), "THD (40%)");
        console.log("üéØ Community TGE:", hre.ethers.formatUnits(tgeCommunity, 18), "THD (20%)");
        console.log("üåê Ecosystem TGE:", hre.ethers.formatUnits(tgeEcosystem, 18), "THD (10%)");
        console.log("üè¶ Treasury TGE:", hre.ethers.formatUnits(tgeTreasury, 18), "THD (20%)");
        console.log("üìä T·ªîNG TGE:", hre.ethers.formatUnits(totalTGE, 18), "THD");
        console.log("üìä TGE PERCENTAGE:", tgePercentage.toString() + "%");
        
        // Vesting amounts
        const vestingNodeOG = nodeOGAllocation - tgeNodeOG;
        const vestingLiquidity = liquidityAllocation - tgeLiquidity;
        const vestingCommunity = communityAllocation - tgeCommunity;
        const vestingEcosystem = ecosystemAllocation - tgeEcosystem;
        const vestingTreasury = treasuryAllocation - tgeTreasury;
        const totalVesting = vestingNodeOG + vestingLiquidity + vestingCommunity + vestingEcosystem + vestingTreasury;
        
        console.log("\nüìà Vesting Amounts:");
        console.log("üåü Node OG Vesting:", hre.ethers.formatUnits(vestingNodeOG, 18), "THD (24 th√°ng)");
        console.log("üíß Liquidity Vesting:", hre.ethers.formatUnits(vestingLiquidity, 18), "THD (12 th√°ng)");
        console.log("üéØ Community Vesting:", hre.ethers.formatUnits(vestingCommunity, 18), "THD (24 th√°ng)");
        console.log("üåê Ecosystem Vesting:", hre.ethers.formatUnits(vestingEcosystem, 18), "THD (30 th√°ng)");
        console.log("üè¶ Treasury Vesting:", hre.ethers.formatUnits(vestingTreasury, 18), "THD (48 th√°ng)");
        console.log("üìä T·ªîNG VESTING:", hre.ethers.formatUnits(totalVesting, 18), "THD");
        
    } catch (error) {
        console.log("‚ùå Error calculating vesting:", error.message);
    }

    // ===== 4. ACCOUNT FEATURES TEST =====
    console.log("\nüéØ ===== 4. ACCOUNT FEATURES TEST =====");
    
    try {
        const accountInfo = await tokenHub.getAccountInfo(tester.address);
        const balance = await tokenHub.balanceOf(tester.address);
        
        console.log("‚úÖ VIP Tier:", accountInfo.vipTier_.toString());
        console.log("‚úÖ Fee Discount:", accountInfo.feeDiscount_.toString(), "%");
        console.log("‚úÖ Blacklist Status:", accountInfo.isBlacklisted_ ? "Blacklisted" : "Not Blacklisted");
        console.log("‚úÖ Token Balance:", hre.ethers.formatUnits(balance, 18), "THD");
        console.log("‚úÖ Voting Power:", hre.ethers.formatUnits(balance, 18), "THD");
        
    } catch (error) {
        console.log("‚ùå Error testing account features:", error.message);
    }

    // ===== 5. TOKEN INFO SUMMARY =====
    console.log("\nüìã ===== 5. TOKEN INFO SUMMARY =====");
    
    try {
        const tokenInfo = await tokenHub.getTokenInfo();
        
        console.log("Name:", tokenInfo.name_);
        console.log("Symbol:", tokenInfo.symbol_);
        console.log("Decimals:", tokenInfo.decimals_.toString());
        console.log("Total Supply:", hre.ethers.formatUnits(tokenInfo.totalSupply_, 18), "THD");
        console.log("Total Burned:", hre.ethers.formatUnits(tokenInfo.totalBurned_, 18), "THD");
        console.log("Minting Enabled:", tokenInfo.mintingEnabled_);
        console.log("Burning Enabled:", tokenInfo.burningEnabled_);
        
    } catch (error) {
        console.log("‚ùå Error getting token info:", error.message);
    }

    // ===== 6. COMPLIANCE VERIFICATION =====
    console.log("\n‚úÖ ===== 6. COMPLIANCE VERIFICATION =====");
    
    try {
        const name = await tokenHub.name();
        const symbol = await tokenHub.symbol();
        const decimals = await tokenHub.decimals();
        const totalSupply = await tokenHub.totalSupply();
        const network = await hre.ethers.provider.getNetwork();
        
        // Basic compliance checks
        const projectNameCorrect = name === "Token Hub";
        const tokenSymbolCorrect = symbol === "THD";
        const decimalsCorrect = Number(decimals) === 18;
        const totalSupplyCorrect = totalSupply === hre.ethers.parseUnits("100000000", 18);
        const networkCorrect = [97, 31337].includes(Number(network.chainId));
        
        console.log("üìã Project Name:", projectNameCorrect ? "‚úÖ PASS" : "‚ùå FAIL");
        console.log("ü™ô Token Symbol:", tokenSymbolCorrect ? "‚úÖ PASS" : "‚ùå FAIL");
        console.log("üî¢ Token Decimals:", decimalsCorrect ? "‚úÖ PASS" : "‚ùå FAIL");
        console.log("üìà Total Supply:", totalSupplyCorrect ? "‚úÖ PASS" : "‚ùå FAIL");
        console.log("üåê Network:", networkCorrect ? "‚úÖ PASS" : "‚ùå FAIL");
        
        // Allocation compliance
        const teamAllocation = await tokenHub.TEAM_ALLOCATION();
        const expectedTeam = hre.ethers.parseUnits("7000000", 18);
        const teamCorrect = teamAllocation === expectedTeam;
        console.log("üë• Team Allocation (7%):", teamCorrect ? "‚úÖ PASS" : "‚ùå FAIL");
        
    } catch (error) {
        console.log("‚ùå Error in compliance check:", error.message);
    }

    // ===== 7. FINAL SUMMARY =====
    console.log("\nüéâ ===== 7. FINAL SUMMARY =====");
    console.log("‚úÖ Contract Address:", contractAddress);
    console.log("‚úÖ Token: Token Hub (THD)");
    console.log("‚úÖ Total Supply: 100,000,000 THD");
    console.log("‚úÖ Network: BSC Testnet");
    console.log("‚úÖ Status: Deployed and Active");
    console.log("‚úÖ Features: Utility & Governance Token");
    console.log("‚úÖ Standard: ERC-20 (BEP-20 Compatible)");
    
    console.log("\nüéØ Test completed successfully!");
    console.log("üìä Deployed contract is working correctly!");
    console.log("üîó View on BSCScan:", `https://testnet.bscscan.com/address/${contractAddress}`);
}

main().catch((error) => {
    console.error("‚ùå Test failed:", error);
    process.exitCode = 1;
});
